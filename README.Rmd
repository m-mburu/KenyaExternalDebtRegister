---
title: "Kenya External Debt Register"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,warnings = FALSE, message = FALSE)
```

## Steps Taken to Develop Public Debt Register data set

- Navigated to the Kenya National Treasury website and downloaded the public debt register data set.
- Extracted the data set using python and saved it as a csv file Script: Python/extract_data.py
- Extracted historical exchange rates data set from the https://www.poundsterlinglive.com/bank-of-england-spot/historical-spot-exchange-rates/usd and saved it as a csv file. Script: Python/historical_currency_data.py
- Downloaded USD inflation data set from https://www.in2013dollars.com/us/inflation/1980?amount=1 to convert into todays equivalent dollars. 
- Downloaded IMF SDR data from https://www.imf.org/external/np/fin/data/rms_sdrv.aspx. This will be used to convert XDR currency to USD
- Used the historical data to convert amounts to dollars and saved the data set as a csv file. Script: R/cleaning.R

## Currency Composition of Kenya's External Debt


```{r,warnings = FALSE, message = FALSE}
library(tidyverse)
library(data.table)
source("R/functions.R")


public_debt <- fread("data/kenya_public_debt.csv")
#public_debt <- public_debt[!is.na(amount_outstanding_as_at_30_06_2023_fx)]
number_curr_df = public_debt[, .(number_curr =.N), 
                             by = .(president, curr)]

plot_bar(data = number_curr_df, 
         x = president, y = number_curr, fill = curr, 
         title = "Number of loans by president",
         xlab = "President", ylab = "Number of loans")

```


## Loan Duration by President


```{r}
brks  <- hist(public_debt$duration_payment_yrs,plot = FALSE)$breaks
ggplot(public_debt, aes(x = duration_payment_yrs)) +
    geom_histogram(breaks = brks) +
    facet_wrap(~president) +
    labs(title = "Loan duration by president", x = "Duration (years)", y = "Count") +
    theme_minimal()

```

## Number of loans by creditor category

```{r}

cretor_category_df = public_debt[, .(number =.N), 
                                 by = .(president, creditor_category)]

plot_bar(data = cretor_category_df, 
         x = president, y = number, fill = creditor_category, 
         title = "Number of loans by president",
         xlab = "President", ylab = "Number of loans")
```


## Histogram of loan duration by creditor category

```{r}
#brks2  <- hist(public_debt$duration_payment_yrs,plot = FALSE)$breaks
ggplot(public_debt, aes(x = duration_payment_yrs)) +
    geom_histogram(breaks = brks) +
    facet_wrap(~creditor_category, scales = "free_y") +
    labs(title = "Loan duration by creditor category", x = "Duration (years)", y = "Count") +
    theme_minimal()
```



## Amount Borrowed by President in USD

```{r}

# financed_amount_2024_usd
financed_amount = public_debt[, .(financed_amount_usd = sum(financed_amount_usd, na.rm = TRUE)), 
                                  by = .(president, creditor_category)]

amount_plot <- ggplot(financed_amount, aes(x = reorder(president, -financed_amount_usd), y = financed_amount_usd/1000000000, fill =creditor_category )) +
    geom_col() +
    scale_fill_manual(values = mycolors) +
    labs(title = "Amount borrowed by president in Billions USD", x = "President", y = "Amount borrowed") +
    theme_minimal()

amount_plot

```

## Cummulative debt by president
- Please note other  cumulative debt might includes interests
- This graph just looks how much a president borrowed when they were in power. This is external debt
- The CBK cumulative debt is the total debt that the country has borrowed - payments
- ***Have you guys checked how many loans EU gave to Kenya on 2002-12-31. First day of Kibaki presidency***

```{r}


setorder(public_debt, agreement_date)
public_debt[, year := year(agreement_date)]
# Compute the loan index by president within each year and president

# sum by year and president
public_debt_per_year <- public_debt[, .(financed_amount_usd = sum(financed_amount_usd, na.rm = T)), by = .(president, year)]

public_debt_per_year[, loan_index_by_president := rowid(president)]
public_debt_per_year[, cummulative_debt := cumsum(financed_amount_usd), by = .(president)]

ggplot(public_debt_per_year, aes(x = loan_index_by_president, y = cummulative_debt/1000000000, color = president)) +
    geom_line(linewidth = 1) +
    scale_color_manual(values = mycolors) +
    labs(title = "Cummulative debt  aquired by president", x = "Year", y = "Amount borrowed (Billion USD)") +
    theme_minimal()+
    theme(legend.position = "bottom")

```

## Loans Still to Convert to USD

```{r}
public_debt_not_converted <- public_debt[is.na(financed_amount_usd), .(loan_ref_number,creditor_name,agreement_date, org_financed_amount,revised_financed_amount, curr)]
knitr::kable(public_debt_not_converted)
```